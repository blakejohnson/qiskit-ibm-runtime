
cache: pip
sudo: false

stage_generic: &stage_linux
  os: linux
  language: python
  python: 3.9
  install:
    - pip install -U -r requirements.txt
    - pip install -U -r requirements-dev.txt

jobs:
  include:
    - stage: "Run code quality checks"
      <<: *stage_linux
      name: "Run black"
      env:
        - NAME=Run black
      script: make style
    - name: "Run lint"
      <<: *stage_linux
      env:
        - NAME=Run lint
      script: make lint
    - name: "Run mypy"
      <<: *stage_linux
      env:
        - NAME=Run mypy
      script: make mypy

    - stage: "Run unit tests"
      <<: *stage_linux
      python: 3.7
      script: make unit-test
    - <<: *stage_linux
      python: 3.8
      script: make unit-test
    - <<: *stage_linux
      python: 3.9
      script: make unit-test
    - <<: *stage_linux
      python: "3.10"
      script: make unit-test

    - stage: "Deploy to staging and run integration tests"
      <<: *stage_linux
      if: branch = master AND type = push AND tag IS blank
      env:
        - QISKIT_IBM_USE_STAGING_CREDENTIALS=true
        - QISKIT_IBM_DEVICE_STAGING=ibmq_qasm_simulator
      script:
        - make staging && make integration-test

    - stage: "Deploy to production and run integration tests"
      <<: *stage_linux
      if: tag IS present
      script:
        - make production && make integration-test
